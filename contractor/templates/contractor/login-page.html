{% load static %}
<!DOCTYPE html>
<html lang="en">
<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<head>
<title>SLP | Login</title>
<link rel="shortcut icon" href="{% static 'img/favicon.png' %}">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Quicksand:500,700" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'css/waves.min.css' %}" type="text/css" media="all">
<link rel="stylesheet" type="text/css" href="{% static 'css/feather.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/themify-icons.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/icofont.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'font-awesome/font-awesome.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/pages.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/media.css' %}">

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>
<body themebg-pattern="theme1">
<nav style="margin-top: 50px;" class="navbar navbar-expand-lg bg-dark navbar-dark ">
  <!-- Links -->
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link" href="{% url 'merchant_login' %}">Merchant</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="{% url 'contractor_login' %}">Contractor</a>
    </li>
  </ul>
  <!-- Navbar text-->
  <span class="navbar-text ml-auto">
    <a class="nav-link" href="{% url 'admin_login' %}">Admin</a>
  </span>
</nav>
<br>
<section class="login-block">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <form action="" method="POST" id="myForm" onsubmit="return checkLogin()" class="md-float-material">
          {% csrf_token %}
          <div class="text-center"> <img src="{% static 'img/logo.png' %}" alt="logo.png" width="150" height="auto"> </div>
          <div class="auth-box card">
            <div class="card-block">
              <div class="row">
                <div class="col-md-12">
                  <h3 class="text-center txt-primary">Sign In</h3>
                </div>
              </div>
              <div class="form-group">
                <label>Contractor Email</label>
                <input type="email" name="user_email" id="user_email" class="form-control" required placeholder="For ex. yourname@email.com">
              </div>
              <div class="form-group">
                <label>Password</label>
                <input type="password" name="password" id="password" class="form-control" minlength="8" required placeholder="Password">
              </div>
              <div class="row text-left">
                <div class="col-12">
                  <div class="checkbox-fade fade-in-primary">
                    <label>
                      <input type="checkbox" value="">
                      <span class="cr"> <i class="cr-icon icofont icofont-ui-check txt-primary"> </i> </span> <span class="text-inverse">Remember me </span> </label>
                  </div>
                </div>
              </div>
              <div class="form-group form-primary m-t-10 text-right">
                  <a href="#" data-toggle="modal" data-target="#reset-pw" onclick="return showModal()">Forgot Password ?</a>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <button type="submit" class="btn btn-primary btn-md btn-block waves-effect text-center">Sign In </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<div class="modal fade show" id="reset-pw" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content p-20">
      
        <div class="modal-header text-center"> 
            <h3 class="w-100 p-b-10">
              <strong>Reset Password</strong>
            </h3>
              <button type="button" class="close" data-dismiss="modal" style="color: red; font-size: 2em;" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
            
        </div>
        <form action="/contractor/checkemail/" method="post">
          {% csrf_token %}
          <div class="modal-body ">
            <div class="clearfix">
                <label>Please Enter Email ID</label>
              <input type="email" class="form-control" name="email" id="email" required placeholder="For ex. youtname@email.com">
            </div>
          </div>
          <div class="modal-footer">
              <button type="submit" class="btn btn-primary waves-effect waves-light">Submit</button>
          </div>
        </form>
    </div>
  </div>
</div>


<script type="text/javascript" src="{% static 'js/jquery.min.js' %}">
  </script> 
<script type="text/javascript" src="{% static 'js/jquery-ui.min.js' %}">
  </script> 
<script type="text/javascript" src="{% static 'js/new files/popper.min.js' %}">
  </script> 
<script type="text/javascript" src="{% static 'js/new files/bootstrap.min.js' %}">
  </script> 
<script src="{% static 'js/waves.min.js' %}" type="text/javascript">
  </script> 
<script type="text/javascript" src="{% static 'js/jquery.slimscroll.js' %}">
  </script> 
<script type="text/javascript" src="{% static 'js/modernizr.js' %}">
  </script> 
<script type="text/javascript" src="{% static 'js/css-scrollbars.js' %}">
  </script> 
<script type="text/javascript" src="{% static 'js/common-pages.js' %}">
  </script> 
<script src="{% static 'js/rocket-loader.min.js' %}" data-cf-settings="|49" defer="">
  </script>

<!-- Script  -->
<script>

// var form = document.getElementById("myForm");
// form.addEventListener('submit', checkRegister);

function checkLogin(){  
    // event.preventDefault();
    // var csrfmiddlewaretoken = $('input[type=hidden]').val();
    // console.log(csrfmiddlewaretoken);
             
    var user_email = document.getElementById('user_email').value.trim();
    var password = document.getElementById('password').value.trim();
  
    if(user_email != ""){
      
        if(password != ""){
          if(password.length >= 8){
            $.ajax({
              type: 'post',
              url:"/contractor/check-signin/",
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
              dataType: 'json',
              data : {
                'user_email' : user_email,
                'password' : password, 
              },
              success: function(msg){
                // console.log(msg);
                // console.log('token',msg.jwtToken);
                // var token = new XMLHttpRequest();
                // token.open('POST','/contractor/dashboard/');
                // token.setRequestHeader('X-CSRFToken','{{ csrf_token }}','token',msg.jwtToken);
                // token.send();
                var localToken = localStorage.getItem('token');
                console.log("local token",localToken);
                localStorage.removeItem('contratortoken');
                
                if(msg.jwtToken != undefined){
                  console.log("Inside if");
                  localStorage.setItem('contratortoken',msg.jwtToken);
                }
                
                swal({
                  'title':msg.message,
                  'text': msg.data,
                  'icon':msg.status,
                }).then(
                    function(){
                      if(msg.status == 'success'){
                        window.location = msg.url;
                      }
                    }
                  );
              },
              error: function(err){
                var markup = err.responseText;
                var parser = new DOMParser()
                var el = parser.parseFromString(markup, "text/html");
                // var el = JSON.parse(markup);
                console.log('EL',el);
                
                // document.querySelector('html').innerHTML = pre;
                var icon;
                if(err.status == 403){
                  var pre = el.querySelector('pre').textContent
                  console.log("per",pre);
                  icon = 'error';

                  swal({
                    'title':err.statusText,
                    'text': pre,
                    'icon':icon,
                  }).then(function(){
                      window.location = '/contractor/signin/';
                    }
                  );
                }
                else if(err.status == 500 || err.status == 404){
                  document.querySelector('html').innerHTML = err.responseText;
                }  
                
              }
            });
          }
          else{
            swal({
              'title': 'Try again!',
              'text': 'Please enter minimum 8 character password...',
              'icon': 'warning'
            });
          }
        }
        else{
          swal({
            'title': 'Try again!',
            'text': 'Password is required...',
            'icon': 'warning'
          });
        }
         
    }
    else{
        swal({
            'title': 'Try again!',
            'text': 'Email is required...',
            'icon': 'warning'
        });
    }
    return false;

}
</script>

{% if message %}
<script>
swal({
  "title":"{{title}}",
  "text": "{{message}}",
  "icon": "{{icon}}"
}).then(function(){
  window.location = "{{url}}";
});
</script>
{% endif %}
<!-- /Script -->
</body>
</html>
